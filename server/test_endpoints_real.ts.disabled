
// test_real_endpoints.ts
import express from 'express';
import request from 'supertest';
import { createExpressApp } from './src/server';
import path from 'path';
import fs from 'fs';
import { getCeDatabase } from './src/modules/catalogEnricher/db/ceDatabase';

// Mock Modules
jest.mock('./src/modules/catalogEnricher/services/cePuppeteerService', () => ({
    initPuppeteerService: jest.fn(),
    startTeacherBrowser: jest.fn().mockResolvedValue({ success: true }),
    // Mock page fetch for crawler
    fetchPageContent: jest.fn().mockResolvedValue('<html><body><div class="card"><h2 class="title">Test Prod</h2><a href="/test" class="btn">Link</a></div></body></html>')
}));

// We need to bypass the actual Socket.IO requirement in index.ts, so we use createExpressApp directly.
// But modules might expect initQueueService to have been called.
// Let's manually init services if needed.
import { initQueueService } from './src/modules/catalogEnricher/services/ceQueueService';
// Mock IO
const mockIO = { emit: jest.fn(), on: jest.fn() } as any;
initQueueService(mockIO);

const app = createExpressApp();

describe('Real Backend Endpoint Tests', () => {

    const db = getCeDatabase();
    // Unique ID for this test run
    const testId = Date.now();
    const profileId = `profile_endpoint_${testId}`;
    const csvPath = path.join(__dirname, `test_upload_${testId}.csv`);

    beforeAll(() => {
        // Setup DB
        db.prepare("INSERT INTO ce_brand_profiles (id, name, domain_root) VALUES (?, 'Endpoint Test Brand', 'example.com')").run(profileId);
        // Create dummy CSV
        fs.writeFileSync(csvPath, "Ref,Name\nE-001, Endpoint Prod 1");
    });

    afterAll(() => {
        // Cleanup
        if (fs.existsSync(csvPath)) fs.unlinkSync(csvPath);
        db.prepare('DELETE FROM ce_web_products WHERE brand_profile_id = ?').run(profileId);
        db.prepare('DELETE FROM ce_job_items WHERE job_id IN (SELECT id FROM ce_jobs WHERE profile_id = ?)').run(profileId);
        db.prepare('DELETE FROM ce_jobs WHERE profile_id = ?').run(profileId);
        db.prepare('DELETE FROM ce_brand_profiles WHERE id = ?').run(profileId);
    });

    test('health check', async () => {
        const res = await request(app).get('/api/catalog-enricher/health');
        expect(res.status).toBe(200);
        expect(res.body.module).toBe('catalog-enricher');
    });

    test('OPTION A: Upload -> Run Job -> Check Status', async () => {
        // 1. Upload
        const upRes = await request(app)
            .post('/api/catalog-enricher/upload')
            .attach('file', csvPath);

        expect(upRes.status).toBe(200);
        expect(upRes.body.success).toBe(true);
        const uploadId = upRes.body.id;
        expect(uploadId).toBeDefined();

        // 2. Start Job
        const runRes = await request(app)
            .post('/api/catalog-enricher/run')
            .send({
                uploadId,
                urlColumn: 'Ref',
                profileId,
                type: 'enrich'
            });

        expect(runRes.status).toBe(200);
        expect(runRes.body.success).toBe(true);
        const jobId = runRes.body.jobId;

        // 3. Check Job Status
        const statusRes = await request(app).get(`/api/catalog-enricher/jobs/${jobId}`);
        expect(statusRes.status).toBe(200);
        expect(statusRes.body.id).toBe(jobId);
        // It might be pending or running or completed (async worker)
        expect(['pending', 'running', 'completed']).toContain(statusRes.body.status);
    });

    // Option C (View Report) Check
    test('VIEW REPORT: Get Job Items', async () => {
        // Create a fake completed job to test the endpoint
        const fakeJobId = `job_fake_${testId}`;
        const now = new Date().toISOString();
        db.prepare(`
            INSERT INTO ce_jobs (id, profile_id, type, status, created_at) 
            VALUES (?, ?, 'enrich', 'completed', ?)
        `).run(fakeJobId, profileId, now);

        db.prepare(`
            INSERT INTO ce_job_items (job_id, row_id, key_value, status, product_url)
            VALUES (?, '1', 'TEST-KEY', 'ok', 'http://test')
        `).run(fakeJobId);

        const res = await request(app).get(`/api/catalog-enricher/jobs/${fakeJobId}/items`);
        expect(res.status).toBe(200);
        expect(res.body.items).toBeDefined();
        expect(res.body.items.length).toBe(1);
        expect(res.body.items[0].key_value).toBe('TEST-KEY');
    });

    test('OPTION B: Crawler Start', async () => {
        const res = await request(app)
            .post('/api/catalog-enricher/crawler/start')
            .send({
                url: 'http://test-site.com',
                profileId,
                selectors: { productCard: '.card' }
            });

        expect(res.status).toBe(200);
        expect(res.body.success).toBe(true);
        expect(res.body.jobId).toBeDefined();
    });

});
